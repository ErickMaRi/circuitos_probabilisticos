"""unit_simulations.py contiene la verificación de la función run_simulations
utiliza datos obtenidos de una simulación en específica, y comprueba su
cercanía con los valores obtenidos por correr las simulación. NgSpice no corre
en una forma uniforme en el tiempo por lo que los resultados de las simulaciones
nunca son exactamente los mismos, esta es la razón por la que se considera con
una cota de error la diferencia entre el valor esperado y el obtenido.
    """
import sys
import os
import unittest
from numpy import array

# Obtener la ruta del directorio actual del archivo unit_simulation.py
current_dir = os.path.dirname(os.path.abspath(__file__))
# Agregar la ruta del directorio 'src' al path de Python
src_dir = os.path.abspath(os.path.join(current_dir, '..', '..', 'src'))
sys.path.append(src_dir)

# Importar la función de simulation.py
from simulation import run_simulations


class TestSimulation(unittest.TestCase):

    def test_run_simulations(self):
        """Revisa la cercanía entre los resultados de simular un circuito conocido
        y los resultados obtenidos para una simulación conocida como exitosa.
        Emplea una tolerancia de 1e-8.
        """
        #Tolerancia con la cual revisar la cercanía de las simulaciones a una verdad
        #arbitraria, ngspice no simula de forma determinista ni uniforme en el tiempo
        #por lo que esa tolerancia es necesaria, falla en LINEAL.cir cuando menor a
        # 1e-9
        tolerancia = 1e-8

        expected_results = {'LINEAL.cir': {'time': array([0.00000000e+00, 2.00000000e-10, 2.16804479e-10, 2.50413437e-10,
       3.17631354e-10, 4.52067187e-10, 7.20938852e-10, 1.25868218e-09,
       1.87713463e-09, 2.89166966e-09, 4.29833217e-09, 6.51822561e-09,
       9.74378009e-09, 1.47123195e-08, 2.00000000e-08, 2.07370448e-08,
       2.22111344e-08, 2.51593136e-08, 3.10556721e-08, 4.28483889e-08,
       6.28483889e-08, 8.28483889e-08, 1.02848389e-07, 1.22848389e-07,
       1.42848389e-07, 1.62848389e-07, 1.82848389e-07, 2.02848389e-07,
       2.22848389e-07, 2.42848389e-07, 2.62848389e-07, 2.82848389e-07,
       3.02848389e-07, 3.22848389e-07, 3.42848389e-07, 3.62848389e-07,
       3.82848389e-07, 4.02848389e-07, 4.22848389e-07, 4.42848389e-07,
       4.62848389e-07, 4.82848389e-07, 5.02848389e-07, 5.22848389e-07,
       5.42848389e-07, 5.62848389e-07, 5.82848389e-07, 6.02848389e-07,
       6.22848389e-07, 6.42848389e-07, 6.62848389e-07, 6.82848389e-07,
       7.02848389e-07, 7.22848389e-07, 7.42848389e-07, 7.62848389e-07,
       7.82848389e-07, 8.02848389e-07, 8.22848389e-07, 8.42848389e-07,
       8.62848389e-07, 8.82848389e-07, 9.02848389e-07, 9.22848389e-07,
       9.42848389e-07, 9.62848389e-07, 9.82848389e-07, 1.00284839e-06,
       1.02284839e-06, 1.04284839e-06, 1.06284839e-06, 1.08284839e-06,
       1.10284839e-06, 1.12284839e-06, 1.14284839e-06, 1.16284839e-06,
       1.18284839e-06, 1.20284839e-06, 1.22284839e-06, 1.24284839e-06,
       1.26284839e-06, 1.28284839e-06, 1.30284839e-06, 1.32284839e-06,
       1.34284839e-06, 1.36284839e-06, 1.38284839e-06, 1.40284839e-06,
       1.42284839e-06, 1.44284839e-06, 1.46284839e-06, 1.48284839e-06,
       1.50284839e-06, 1.52284839e-06, 1.54284839e-06, 1.56284839e-06,
       1.58284839e-06, 1.60284839e-06, 1.62284839e-06, 1.64284839e-06,
       1.66284839e-06, 1.68284839e-06, 1.70284839e-06, 1.72284839e-06,
       1.74284839e-06, 1.76284839e-06, 1.78284839e-06, 1.80284839e-06,
       1.82284839e-06, 1.84284839e-06, 1.86284839e-06, 1.88284839e-06,
       1.90284839e-06, 1.92284839e-06, 1.94284839e-06, 1.96284839e-06,
       1.98284839e-06, 2.00284839e-06, 2.02284839e-06, 2.04284839e-06,
       2.06284839e-06, 2.08284839e-06, 2.10284839e-06, 2.12284839e-06,
       2.14284839e-06, 2.16284839e-06, 2.18284839e-06, 2.20284839e-06,
       2.22284839e-06, 2.24284839e-06, 2.26284839e-06, 2.28284839e-06,
       2.30284839e-06, 2.32284839e-06, 2.34284839e-06, 2.36284839e-06,
       2.38284839e-06, 2.40284839e-06, 2.42284839e-06, 2.44284839e-06,
       2.46284839e-06, 2.48284839e-06, 2.50284839e-06, 2.52284839e-06,
       2.54284839e-06, 2.56284839e-06, 2.58284839e-06, 2.60284839e-06,
       2.62284839e-06, 2.64284839e-06, 2.66284839e-06, 2.68284839e-06,
       2.70284839e-06, 2.72284839e-06, 2.74284839e-06, 2.76284839e-06,
       2.78284839e-06, 2.80284839e-06, 2.82284839e-06, 2.84284839e-06,
       2.86284839e-06, 2.88284839e-06, 2.90284839e-06, 2.92284839e-06,
       2.94284839e-06, 2.96284839e-06, 2.98284839e-06, 3.00284839e-06,
       3.02284839e-06, 3.04284839e-06, 3.06284839e-06, 3.08284839e-06,
       3.10284839e-06, 3.12284839e-06, 3.14284839e-06, 3.16284839e-06,
       3.18284839e-06, 3.20284839e-06, 3.22284839e-06, 3.24284839e-06,
       3.26284839e-06, 3.28284839e-06, 3.30284839e-06, 3.32284839e-06,
       3.34284839e-06, 3.36284839e-06, 3.38284839e-06, 3.40284839e-06,
       3.42284839e-06, 3.44284839e-06, 3.46284839e-06, 3.48284839e-06,
       3.50284839e-06, 3.52284839e-06, 3.54284839e-06, 3.56284839e-06,
       3.58284839e-06, 3.60284839e-06, 3.62284839e-06, 3.64284839e-06,
       3.66284839e-06, 3.68284839e-06, 3.70284839e-06, 3.72284839e-06,
       3.74284839e-06, 3.76284839e-06, 3.78284839e-06, 3.80284839e-06,
       3.82284839e-06, 3.84284839e-06, 3.86284839e-06, 3.88284839e-06,
       3.90284839e-06, 3.92284839e-06, 3.94284839e-06, 3.96284839e-06,
       3.98284839e-06, 4.00284839e-06, 4.02284839e-06, 4.04284839e-06,
       4.06284839e-06, 4.08284839e-06, 4.10284839e-06, 4.12284839e-06,
       4.14284839e-06, 4.16284839e-06, 4.18284839e-06, 4.20284839e-06,
       4.22284839e-06, 4.24284839e-06, 4.26284839e-06, 4.28284839e-06,
       4.30284839e-06, 4.32284839e-06, 4.34284839e-06, 4.36284839e-06,
       4.38284839e-06, 4.40284839e-06, 4.42284839e-06, 4.44284839e-06,
       4.46284839e-06, 4.48284839e-06, 4.50284839e-06, 4.52284839e-06,
       4.54284839e-06, 4.56284839e-06, 4.58284839e-06, 4.60284839e-06,
       4.62284839e-06, 4.64284839e-06, 4.66284839e-06, 4.68284839e-06,
       4.70284839e-06, 4.72284839e-06, 4.74284839e-06, 4.76284839e-06,
       4.78284839e-06, 4.80284839e-06, 4.82284839e-06, 4.84284839e-06,
       4.86284839e-06, 4.88284839e-06, 4.90284839e-06, 4.92284839e-06,
       4.94284839e-06, 4.96284839e-06, 4.98284839e-06, 5.00284839e-06,
       5.02284839e-06, 5.04284839e-06, 5.06284839e-06, 5.08284839e-06,
       5.10284839e-06, 5.12284839e-06, 5.14284839e-06, 5.16284839e-06,
       5.18284839e-06, 5.20284839e-06, 5.22284839e-06, 5.24284839e-06,
       5.26284839e-06, 5.28284839e-06, 5.30284839e-06, 5.32284839e-06,
       5.34284839e-06, 5.36284839e-06, 5.38284839e-06, 5.40284839e-06,
       5.42284839e-06, 5.44284839e-06, 5.46284839e-06, 5.48284839e-06,
       5.50284839e-06, 5.52284839e-06, 5.54284839e-06, 5.56284839e-06,
       5.58284839e-06, 5.60284839e-06, 5.62284839e-06, 5.64284839e-06,
       5.66284839e-06, 5.68284839e-06, 5.70284839e-06, 5.72284839e-06,
       5.74284839e-06, 5.76284839e-06, 5.78284839e-06, 5.80284839e-06,
       5.82284839e-06, 5.84284839e-06, 5.86284839e-06, 5.88284839e-06,
       5.90284839e-06, 5.92284839e-06, 5.94284839e-06, 5.96284839e-06,
       5.98284839e-06, 6.00284839e-06, 6.02284839e-06, 6.04284839e-06,
       6.06284839e-06, 6.08284839e-06, 6.10284839e-06, 6.12284839e-06,
       6.14284839e-06, 6.16284839e-06, 6.18284839e-06, 6.20284839e-06,
       6.22284839e-06, 6.24284839e-06, 6.26284839e-06, 6.28284839e-06,
       6.30284839e-06, 6.32284839e-06, 6.34284839e-06, 6.36284839e-06,
       6.38284839e-06, 6.40284839e-06, 6.42284839e-06, 6.44284839e-06,
       6.46284839e-06, 6.48284839e-06, 6.50284839e-06, 6.52284839e-06,
       6.54284839e-06, 6.56284839e-06, 6.58284839e-06, 6.60284839e-06,
       6.62284839e-06, 6.64284839e-06, 6.66284839e-06, 6.68284839e-06,
       6.70284839e-06, 6.72284839e-06, 6.74284839e-06, 6.76284839e-06,
       6.78284839e-06, 6.80284839e-06, 6.82284839e-06, 6.84284839e-06,
       6.86284839e-06, 6.88284839e-06, 6.90284839e-06, 6.92284839e-06,
       6.94284839e-06, 6.96284839e-06, 6.98284839e-06, 7.00284839e-06,
       7.02284839e-06, 7.04284839e-06, 7.06284839e-06, 7.08284839e-06,
       7.10284839e-06, 7.12284839e-06, 7.14284839e-06, 7.16284839e-06,
       7.18284839e-06, 7.20284839e-06, 7.22284839e-06, 7.24284839e-06,
       7.26284839e-06, 7.28284839e-06, 7.30284839e-06, 7.32284839e-06,
       7.34284839e-06, 7.36284839e-06, 7.38284839e-06, 7.40284839e-06,
       7.42284839e-06, 7.44284839e-06, 7.46284839e-06, 7.48284839e-06,
       7.50284839e-06, 7.52284839e-06, 7.54284839e-06, 7.56284839e-06,
       7.58284839e-06, 7.60284839e-06, 7.62284839e-06, 7.64284839e-06,
       7.66284839e-06, 7.68284839e-06, 7.70284839e-06, 7.72284839e-06,
       7.74284839e-06, 7.76284839e-06, 7.78284839e-06, 7.80284839e-06,
       7.82284839e-06, 7.84284839e-06, 7.86284839e-06, 7.88284839e-06,
       7.90284839e-06, 7.92284839e-06, 7.94284839e-06, 7.96284839e-06,
       7.98284839e-06, 8.00284839e-06, 8.02284839e-06, 8.04284839e-06,
       8.06284839e-06, 8.08284839e-06, 8.10284839e-06, 8.12284839e-06,
       8.14284839e-06, 8.16284839e-06, 8.18284839e-06, 8.20284839e-06,
       8.22284839e-06, 8.24284839e-06, 8.26284839e-06, 8.28284839e-06,
       8.30284839e-06, 8.32284839e-06, 8.34284839e-06, 8.36284839e-06,
       8.38284839e-06, 8.40284839e-06, 8.42284839e-06, 8.44284839e-06,
       8.46284839e-06, 8.48284839e-06, 8.50284839e-06, 8.52284839e-06,
       8.54284839e-06, 8.56284839e-06, 8.58284839e-06, 8.60284839e-06,
       8.62284839e-06, 8.64284839e-06, 8.66284839e-06, 8.68284839e-06,
       8.70284839e-06, 8.72284839e-06, 8.74284839e-06, 8.76284839e-06,
       8.78284839e-06, 8.80284839e-06, 8.82284839e-06, 8.84284839e-06,
       8.86284839e-06, 8.88284839e-06, 8.90284839e-06, 8.92284839e-06,
       8.94284839e-06, 8.96284839e-06, 8.98284839e-06, 9.00284839e-06,
       9.02284839e-06, 9.04284839e-06, 9.06284839e-06, 9.08284839e-06,
       9.10284839e-06, 9.12284839e-06, 9.14284839e-06, 9.16284839e-06,
       9.18284839e-06, 9.20284839e-06, 9.22284839e-06, 9.24284839e-06,
       9.26284839e-06, 9.28284839e-06, 9.30284839e-06, 9.32284839e-06,
       9.34284839e-06, 9.36284839e-06, 9.38284839e-06, 9.40284839e-06,
       9.42284839e-06, 9.44284839e-06, 9.46284839e-06, 9.48284839e-06,
       9.50284839e-06, 9.52284839e-06, 9.54284839e-06, 9.56284839e-06,
       9.58284839e-06, 9.60284839e-06, 9.62284839e-06, 9.64284839e-06,
       9.66284839e-06, 9.68284839e-06, 9.70284839e-06, 9.72284839e-06,
       9.74284839e-06, 9.76284839e-06, 9.78284839e-06, 9.80284839e-06,
       9.82284839e-06, 9.84284839e-06, 9.86284839e-06, 9.88284839e-06,
       9.90284839e-06, 9.92284839e-06, 9.94284839e-06, 9.96284839e-06,
       9.98284839e-06, 1.00000000e-05]), 'V(3)': array([0.        , 0.009998  , 0.01083804, 0.0125181 , 0.01587804,
       0.02259725, 0.03603295, 0.06289355, 0.09376781, 0.14437406,
       0.21445576, 0.32485519, 0.48483807, 0.7302846 , 0.9902002 ,
       0.98948645, 0.98806213, 0.98523238, 0.97964771, 0.96877196,
       0.95119184, 0.93465467, 0.91910614, 0.90449471, 0.89077148,
       0.87789004, 0.86580638, 0.85447872, 0.84386744, 0.83393493,
       0.82464553, 0.81596538, 0.80786238, 0.80030606, 0.79326753,
       0.78671935, 0.78063552, 0.77499136, 0.76976346, 0.7649296 ,
       0.76046872, 0.75636083, 0.75258697, 0.74912915, 0.74597032,
       0.74309429, 0.74048571, 0.73813002, 0.73601341, 0.73412278,
       0.73244571, 0.73097041, 0.72968571, 0.72858101, 0.72764627,
       0.72687194, 0.72624899, 0.72576885, 0.72542339, 0.72520491,
       0.7251061 , 0.72512003, 0.72524013, 0.72546017, 0.72577427,
       0.72617681, 0.72666249, 0.72722629, 0.72786344, 0.72856943,
       0.72933998, 0.73017102, 0.73105872, 0.73199944, 0.73298973,
       0.73402632, 0.73510611, 0.73622617, 0.73738373, 0.73857615,
       0.73980095, 0.74105576, 0.74233836, 0.74364663, 0.74497857,
       0.74633229, 0.74770601, 0.74909801, 0.75050671, 0.75193058,
       0.7533682 , 0.7548182 , 0.75627931, 0.75775031, 0.75923006,
       0.76071748, 0.76221155, 0.76371131, 0.76521583, 0.76672428,
       0.76823582, 0.7697497 , 0.7712652 , 0.77278164, 0.77429838,
       0.77581481, 0.77733037, 0.77884452, 0.78035675, 0.7818666 ,
       0.78337363, 0.7848774 , 0.78637754, 0.78787367, 0.78936544,
       0.79085255, 0.79233467, 0.79381154, 0.79528288, 0.79674844,
       0.79820801, 0.79966136, 0.8011083 , 0.80254863, 0.80398219,
       0.80540881, 0.80682835, 0.80824068, 0.80964566, 0.81104319,
       0.81243315, 0.81381544, 0.81518999, 0.81655671, 0.81791553,
       0.81926638, 0.82060921, 0.82194396, 0.82327058, 0.82458905,
       0.82589932, 0.82720136, 0.82849515, 0.82978067, 0.83105791,
       0.83232685, 0.83358749, 0.83483982, 0.83608384, 0.83731956,
       0.83854698, 0.83976611, 0.84097696, 0.84217955, 0.84337389,
       0.84455999, 0.84573789, 0.84690761, 0.84806916, 0.84922257,
       0.85036788, 0.85150511, 0.8526343 , 0.85375547, 0.85486865,
       0.85597389, 0.85707122, 0.85816067, 0.85924229, 0.8603161 ,
       0.86138216, 0.86244049, 0.86349114, 0.86453416, 0.86556958,
       0.86659744, 0.86761779, 0.86863067, 0.86963612, 0.87063419,
       0.87162493, 0.87260836, 0.87358455, 0.87455354, 0.87551536,
       0.87647007, 0.87741772, 0.87835833, 0.87929197, 0.88021868,
       0.88113849, 0.88205147, 0.88295765, 0.88385708, 0.8847498 ,
       0.88563586, 0.88651531, 0.88738818, 0.88825454, 0.88911441,
       0.88996785, 0.89081489, 0.8916556 , 0.89249   , 0.89331814,
       0.89414007, 0.89495584, 0.89576548, 0.89656904, 0.89736656,
       0.89815809, 0.89894367, 0.89972334, 0.90049714, 0.90126512,
       0.90202732, 0.90278378, 0.90353454, 0.90427965, 0.90501914,
       0.90575306, 0.90648145, 0.90720435, 0.90792179, 0.90863382,
       0.90934048, 0.91004181, 0.91073785, 0.91142863, 0.9121142 ,
       0.91279459, 0.91346985, 0.91414   , 0.9148051 , 0.91546517,
       0.91612025, 0.91677038, 0.9174156 , 0.91805595, 0.91869145,
       0.91932216, 0.91994809, 0.92056929, 0.9211858 , 0.92179764,
       0.92240486, 0.92300749, 0.92360556, 0.9241991 , 0.92478816,
       0.92537276, 0.92595294, 0.92652873, 0.92710016, 0.92766727,
       0.92823009, 0.92878866, 0.92934299, 0.92989313, 0.93043911,
       0.93098096, 0.9315187 , 0.93205238, 0.93258201, 0.93310764,
       0.93362929, 0.93414699, 0.93466078, 0.93517067, 0.93567671,
       0.93617891, 0.93667731, 0.93717194, 0.93766283, 0.93814999,
       0.93863347, 0.93911329, 0.93958948, 0.94006206, 0.94053107,
       0.94099652, 0.94145845, 0.94191688, 0.94237184, 0.94282336,
       0.94327146, 0.94371616, 0.9441575 , 0.94459549, 0.94503017,
       0.94546156, 0.94588968, 0.94631455, 0.94673622, 0.94715468,
       0.94756998, 0.94798214, 0.94839117, 0.94879711, 0.94919997,
       0.94959978, 0.94999656, 0.95039034, 0.95078113, 0.95116897,
       0.95155387, 0.95193585, 0.95231494, 0.95269116, 0.95306453,
       0.95343508, 0.95380281, 0.95416777, 0.95452995, 0.9548894 ,
       0.95524612, 0.95560014, 0.95595148, 0.95630016, 0.9566462 ,
       0.95698962, 0.95733043, 0.95766867, 0.95800434, 0.95833747,
       0.95866808, 0.95899618, 0.9593218 , 0.95964495, 0.95996566,
       0.96028393, 0.9605998 , 0.96091327, 0.96122437, 0.96153311,
       0.96183951, 0.9621436 , 0.96244537, 0.96274487, 0.96304209,
       0.96333707, 0.96362981, 0.96392033, 0.96420865, 0.96449479,
       0.96477876, 0.96506058, 0.96534027, 0.96561783, 0.9658933 ,
       0.96616667, 0.96643798, 0.96670723, 0.96697445, 0.96723963,
       0.96750281, 0.967764  , 0.96802321, 0.96828045, 0.96853575,
       0.96878911, 0.96904055, 0.96929009, 0.96953774, 0.96978351,
       0.97002742, 0.97026948, 0.97050971, 0.97074812, 0.97098473,
       0.97121954, 0.97145257, 0.97168384, 0.97191335, 0.97214113,
       0.97236718, 0.97259152, 0.97281416, 0.97303511, 0.97325439,
       0.97347201, 0.97368798, 0.97390232, 0.97411503, 0.97432613,
       0.97453563, 0.97474354, 0.97494988, 0.97515465, 0.97535787,
       0.97555956, 0.97575971, 0.97595835, 0.97615549, 0.97635113,
       0.97654529, 0.97673798, 0.97692921, 0.97711899, 0.97730733,
       0.97749425, 0.97767975, 0.97786384, 0.97804654, 0.97822786,
       0.9784078 , 0.97858638, 0.9787636 , 0.97893949, 0.97911404,
       0.97928726, 0.97945918, 0.97962979, 0.97979912, 0.97996715,
       0.98013392, 0.98029942, 0.98046367, 0.98062667, 0.98078844,
       0.98094898, 0.98110831, 0.98126643, 0.98142335, 0.98157909,
       0.98173364, 0.98188702, 0.98203924, 0.98219031, 0.98234023,
       0.98248901, 0.98263667, 0.98278321, 0.98292864, 0.98307297,
       0.98321621, 0.98335836, 0.98349943, 0.98363943, 0.98377837,
       0.98391626, 0.98405311, 0.98418892, 0.9843237 , 0.98445745,
       0.9845902 , 0.98472194, 0.98485268, 0.98498243, 0.98511119,
       0.98523899, 0.98536581, 0.98549167, 0.98561658, 0.98574054,
       0.98586356, 0.98598565, 0.98610682, 0.98622706, 0.9863464 ,
       0.98646483, 0.98658237, 0.98669901, 0.98681477, 0.98692965,
       0.98704366, 0.98715681, 0.9872691 , 0.98738054, 0.98749114,
       0.98760089, 0.98770982, 0.98781792, 0.9879252 , 0.98803167,
       0.98813733, 0.98824219, 0.98834625, 0.98844953, 0.98855202,
       0.98865374, 0.98875469, 0.98885487, 0.98895429, 0.98905296,
       0.98915088, 0.98924806, 0.9893445 , 0.98944022, 0.9895352 ,
       0.98962947, 0.98972302, 0.98981586, 0.989908  , 0.98999944,
       0.99009019, 0.99018025, 0.99026963, 0.99035833, 0.99044636,
       0.99053372, 0.99062042, 0.99070646, 0.99079185, 0.99087659,
       0.99096069, 0.99104415, 0.99112698, 0.99120918, 0.99129076,
       0.99137172, 0.99145207, 0.99153181, 0.99161094, 0.99168947,
       0.99176741, 0.99184476, 0.99191062])}}

        # Ejecutar la función de simulación
        simulation_results = run_simulations(cir_folder="App\\cir_parser_app\\src\\unit_testing\\", output='V(3)', prog=False)

        for file, expected in expected_results.items():
            simulation = simulation_results[file]
            for key, expected_array in expected.items():
                diff = expected_array - simulation[key]
                for x in diff:
                    #Revisamos que la diferencia entre los arrays sea pequeña.
                    self.assertTrue(bool(abs(x) < tolerancia))

if __name__ == '__main__':
    unittest.main()
